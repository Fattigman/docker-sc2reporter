{% extends "layout.html" %}

{% block body %}
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>


<h1>Report for selected samples</h1>

{% if samples|length >2 %}
<br><button>This does not work yet but will display the tree of chosen samples</button></a>
{% else: %}
<div>
<h3>Too display a phylogenetic tree, minimum of three samples are required</h3>
</div>
{% endif %}

<br>
<h3>Samples with type</h3>
<table>
  <thead>
    <tr><th>Sample</th>
    <th>Collection date</th>
    <th>Significant mutations</th>
    <th>NextClade</th>
    <th>Pango type</th>
    
    <th>Date added</th>
    </thead>
  {% for sample in samples %}
<tr>
  <td><a href="{{ url_for("report", sample_id=sample, max_diff=5, verbosity="simple") }}">{{sample.sample_id}}</a></td>

  <td>{{sample.collection_date|date_notime }}</td>

  <td>
    {% for v in sample.significant_variants %}
    <span class="variant tag"><a href="{{ url_for('variant', var_id=v.id) }}">{{v.aa}}</a></span>&nbsp;
    {% endfor %}
  </td>
  <td>{{sample.nextclade }}</td>
  <td>{{sample.pangolin.type }}</td>
  <td>{{sample.time_added|date_notime }}</td>
</tr>
{% endfor %}
</tbody>
</table>


{% if (qc_pass or advanced) and not no_comparison %}
{% if variant_data|length > 1 %}
<h3>Variants of all similar samples (max {{max_diff}} differences)</h3>
<table>
  <tr>
    <thead>
      <th>Sample</th>
      {% if advanced %}
      <th>Coll. date</th>
      {% endif %}
      <th>Pango</th>
      <th># diffs</th>
      {% for var in variants|pos_sort %}
      <th>{{var|replace("_","<br>")|safe}}</th>
      {% endfor %}
    </thead>
  </tr>
  {% for sample_id, data in variant_data.items() %}
  <tr>
    <td><a href="{{ url_for('report', sample_id=data.sample_data._id, max_diff=max_diff, verbosity=verbosity) }}">{{ data.sample_data.sample_id }}</a></td>
    {% if advanced %}
    <td>{{ data.sample_data.collection_date|date_notime }}</td>
    {% endif %}
    <td>{{ data.sample_data.pangolin.type }}</td>
    <td>{% if data.sample_data.n_diff >= 0 %} {{ data.sample_data.n_diff }} {% endif %}</td>
    {% for variant_id in data.variants.keys()|pos_sort %}

    {% set status = data.variants[variant_id]["status"] %}
    {% set var_parts = variant_id.split('_') %}
    {% set bases = var_parts[1].split('>') %}

    {% set del = true if bases[0]|length > bases[1]|length %}
    {% set ins = true if bases[0]|length < bases[1]|length %}
    {% set dp_base = "DEL" if del else "REFSKIP" if ins else bases[1][0] %}
    {% set dp_pos = (var_parts[0]|int + 1) if del or ins else var_parts[0]|int %}
    {% set dp =  depth[sample_id][dp_pos] %}
    {% set dpdp =  dp.dp if "dp" in dp else -2 %}
    {% set dp_pos_base = dp[dp_base] if dp_base in dp else 0 %}
    {% set vaf = 100*dp_pos_base/(dpdp+1) %}

					   
    {% set dp_str = "%.1f%%<br>(%d/%d)"|format(vaf, dp_pos_base, dpdp)|safe %}

    {% if status == "match" %}
    <td class="ok">{% if advanced %}{{dp_str }}{% else %}X{% endif %}</td>
    {% elif status == "additional" %}
    <td class="warning">{% if advanced %}{{ dp_str}}{% else %}X{% endif %}</td>
    {% elif dpdp < 10 %}
    <td class="nodata">{{ dp_pos_base }}/{{ dpdp }}</td>
    {% else %}
      {% if vaf > 5 %}
        <td class="lowfreq">{% if advanced %}{{ dp_str }}{% else %}{{ "%.1f%%"|format(vaf) }}{% endif %}</td>
      {% else %}
        <td class="missing">{% if advanced %}{{ dp_str }}{% endif %}</td>
      {% endif %}
    {% endif %}
    {% endfor %}
  </tr>
  {% endfor %}
</table>
{% else %}
<br>No similar samples were found
{% endif %}
{% endif %}
{#{variant_annotation}#}

{% endblock %}

