{% extends "layout.html" %}

{% block body %}
{% set advanced = true if verbosity=="advanced" else false %}
{%if advanced %}Showing {{samples|count}} unique samples<br><br>{% endif %}

<!-- Dependencies -->
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>



<div class="grid-container">
<div class="grid-child first center">
<a href="http://localhost:8000/sc2rep/createtree/all/treeeeee"><button style="margin-bottom: 10px;">Visualize all samples in GrapeTree</button></a>
</div>
<div class="grid-child second">
<form id="pango-submit">
  <div  class="search">Select Samples:  <input id="pango-select" type="text" placeholder="sample, pango, time"></div>
</form>
<script>
  var form = document.getElementById("pango-submit");
  function handleForm(event) { 
    event.preventDefault(); 
    const pango_type = document.getElementById('pango-select').value
    const checkboxes = document.getElementsByClassName(pango_type)
    Array.from(checkboxes).forEach(e => 
      e.checked = true
    )
  } 
  form.addEventListener('submit', handleForm);
</script>
</div>
</div>
<form method="post" action="samples">
  <input  type="submit" class="sample-submit" value="Submit selected samples for comparison"> 

<table id="myTable" class="display">
  
  <thead>
    <tr><th>Select</th><th>Time added</th><th>Sample</th><th>QC</th><th>Pangolin</th><th>Significant variants</th><th>Coll. date</th>{% if advanced %}<th>Ct</th><th>%N</th><th>mapped reads</th><th>Sequencing run</th><th>Sex</th><th>Age</th><th>MLU</th><th>Orig. lab</th><th>Seq. lab</th>{% endif %}<th>Criterion</th></tr>
  </thead>
  {% for sample in samples %}
  <tr>
    <td>
      {% set date = sample.time_added|human_date %}
      <input class="{{ sample.pangolin.type }} {{ sample.sample_id }} {{ date[0:4] }} {{ date[5:7] }} {{ date[8:10] }} {{ date[0:7] }} {{ date[0:10] }}" type="checkbox" name="check" value="{{sample.sample_id}}">
    </td>
    <td>
      {{ sample.time_added|human_date }}
    </td>
    <td>
      <a href="report/{{sample._id}}/5/{{verbosity}}">{{sample.sample_id}}</a>
    </td>

    {% if sample.qc.pct_N_bases|int < 10 %}
      <td>OK</td>
      {% if sample.pangolin.type in lineages_of_concern %}				      
      <td><span class="info"><a href="{{ url_for('pangolin', pango_type=sample.pangolin.type) }}">{{sample.pangolin.type}}</a></span></td>
      {% else %}
      <td><a href="{{ url_for('pangolin', pango_type=sample.pangolin.type) }}">{{sample.pangolin.type}}</a></td>
      {% endif %}
    {% else %}
    <td><span class="fail tag">FAIL</span></td><td>-</td>
    {% endif %}
    <td>
      {% for v in sample.significant_variants %}
      <span class="variant tag"><a href="{{ url_for('variant', var_id=v.id) }}">{{v.aa}}</a></span>&nbsp;
      {% endfor %}
    </td>
    <td>{{ sample.collection_date|date_notime }}</td>
    {% if advanced %}
    <td>
      {% if "Ct" in sample %}
        {% if sample.Ct == "Undetermined" %}
          <span class="fail tag">Undet</span>
        {% elif sample.Ct|int > 30 %}
          <span class="warn tag">{{ "%.1f"|format(sample.Ct|float) }}</span>
        {% else %}
          <span class="success tag">{{ "%.1f"|format(sample.Ct|float) }}</span>
        {% endif %}
      {% else %}
        <span class="missing tag">N/A</span>
      {% endif %}
    </td>
    <td>{{ "%.1f"|format(sample.qc.pct_N_bases) }}%</td>
    <td>{{ sample.qc.num_aligned_reads }} ({{ sample.qc.on_target }}%)</td>
    {% set path_parts = sample.vcf_filename.split('/') %}
    <td>{{ path_parts[-2] }}</td>
    <td>{{ sample.sex }}</td>
    <td>{{ sample.age }}</td>
    <td>{{ sample.mlu }}</td>
    <td>{{ sample.lab }}</td>
    <td>{{ sample.seqfacility }}</td>
    {% endif %}

    <td>{{ sample.selection_criterion|safe }}</td>

  </tr>
{% endfor %}
</table>
</form>

<script>
  $(document).ready( function () {
    $('#myTable').DataTable();
} );
$('#myTable').dataTable({
    aLengthMenu: [
        [25, 50, 100, 200, -1],
        [25, 50, 100, 200, "All"]
    ],
    iDisplayLength: -1
});
</script>
{% endblock %}
